enum Role {
    USER
    ADMIN
    ORGANIZER
}

enum PaymentStatus {
    PENDING
    PAID
    FAILED
    CANCELLED
}

enum MerchantType {
    BANK
    EWALLET
}

enum TicketStatus {
    AVAILABLE
    SOLD_OUT
    INACTIVE
}

enum PaymentCategory {
    CARD
    VA
    QRIS
    EWALLET
}

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id            String    @id @default(cuid())
    name          String?
    email         String?   @unique
    emailVerified DateTime? @map("email_verified")
    image         String?
    role          Role      @default(USER)
    date_of_birth DateTime? @map("tanggal_lahir")
    phone_number  String?   @map("nomor_telepon")
    password      String?
    session_token String?
    user_agent    String?
    created_at    DateTime  @default(now())

    accounts         Account[]
    sessions         Session[]
    organizations    Organization[]       @relation("UserOrganizations")
    notifications    Notification[]
    devices          UserDevice[]
    bookings         CustomerBooking[]
    paymentHistories PaymentHistory[]
    organizedEvents  Event[]              @relation("EventOrganizer")
    credentials      Credential[]
    eventAnalytics   EventAnalytics[]     @relation("OrganizerAnalytics")
    paymentChannels  UserPaymentChannel[]
}

model Account {
    id                String  @id @default(cuid())
    userId            String  @map("user_id")
    type              String
    provider          String
    providerAccountId String  @map("provider_account_id")
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@map("accounts")
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique @map("session_token")
    userId       String   @map("user_id")
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("sessions")
}

model VerificationToken {
    identifier String
    token      String
    expires    DateTime

    @@unique([identifier, token])
    @@map("verification_tokens")
}

model Organization {
    id          String   @id @default(cuid())
    name        String
    description String
    location    String
    joined_at   DateTime
    created_at  DateTime @default(now())
    userId      String
    url_name    String   @unique

    user            User                @relation("UserOrganizations", fields: [userId], references: [id])
    events          Event[]
    documents       OrgLegalDocument[]
    paymentChannels OrgPaymentChannel[]
}

model Event {
    id             String   @id @default(cuid())
    organizationId String
    name           String
    description    String
    capacity       Int
    organizerId    String
    started_at     DateTime
    ended_at       DateTime
    promo_id       String?
    is_fullybooked Boolean
    max_capacity   Int
    ticket_count   Int
    is_promo       Boolean
    labels         String[]
    created_at     DateTime @default(now())

    organization     Organization      @relation(fields: [organizationId], references: [id])
    organizer        User              @relation("EventOrganizer", fields: [organizerId], references: [id])
    promo            PromoCode?        @relation("EventPromo", fields: [promo_id], references: [code])
    tickets          Ticket[]
    analytics        EventAnalytics?
    bookings         CustomerBooking[]
    paymentHistories PaymentHistory[]
    invoices         EventInvoice[]
}

model PromoCode {
    code                    String   @id
    amount                  Float
    valid_thru              DateTime
    description             String
    max_promo_used_per_user Int
    created_at              DateTime @default(now())

    events Event[] @relation("EventPromo")
}

model Ticket {
    id             String       @id @default(cuid())
    name           String
    description    String
    price          Float
    total_price    Float
    sales_start_at DateTime
    sales_ended_at DateTime
    status         TicketStatus
    created_at     DateTime     @default(now())
    eventId        String

    event            Event               @relation(fields: [eventId], references: [id])
    bookings         CustomerBooking[]
    paymentHistories PaymentHistory[]
    invoices         EventInvoice[]
    paymentChannels  OrgPaymentChannel[] @relation("TicketPaymentChannels")
}

model EventAnalytics {
    id                 String   @id @default(cuid())
    total_event        String
    ticket_sold        Int
    revenue_per_ticket Float
    total_revenue      Float
    tickets_made       Int
    customers_total    Int
    created_at         DateTime @default(now())
    eventId            String   @unique
    organizerId        String

    event     Event @relation(fields: [eventId], references: [id])
    organizer User  @relation("OrganizerAnalytics", fields: [organizerId], references: [id])
}

model CustomerBooking {
    id             String        @id @default(cuid())
    ticketId       String
    payment_status PaymentStatus
    userId         String
    eventId        String
    invoiceId      String?
    created_at     DateTime      @default(now())

    ticket         Ticket           @relation(fields: [ticketId], references: [id])
    user           User             @relation(fields: [userId], references: [id])
    event          Event            @relation(fields: [eventId], references: [id])
    PaymentHistory PaymentHistory[]
    invoice        EventInvoice?    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model PaymentHistory {
    id                  String        @id @default(cuid())
    ticketId            String
    bookingId           String
    eventId             String
    payment_status      PaymentStatus
    userId              String
    userPaymentChannelId String

    ticket            Ticket            @relation(fields: [ticketId], references: [id])
    booking           CustomerBooking   @relation(fields: [bookingId], references: [id])
    event             Event             @relation(fields: [eventId], references: [id])
    user              User              @relation(fields: [userId], references: [id])
    userPaymentMethod UserPaymentChannel @relation(fields: [userPaymentChannelId], references: [id])
}

model UserDevice {
    id            String   @id @default(cuid())
    userId        String
    session_token String?
    device_name   String
    user_agent    String
    last_used_at  DateTime
    device_token  String   @unique
    is_active     Boolean  @default(true)
    created_at    DateTime @default(now())

    user       User         @relation(fields: [userId], references: [id])
    Credential Credential[]
}

model Notification {
    id          String   @id @default(cuid())
    title       String
    description String
    detail      String?
    userId      String
    is_readed   Boolean
    created_at  DateTime @default(now())

    user User @relation(fields: [userId], references: [id])
}

model Credential {
    id           String      @id @default(cuid())
    user         User        @relation(fields: [userId], references: [id])
    userId       String
    credentialID String      @unique
    publicKey    String
    counter      Int
    challenge    String
    transports   String?
    lastUsedAt   DateTime?
    deviceId     String?
    is_active    Boolean     @default(true)
    device       UserDevice? @relation(fields: [deviceId], references: [id])
    createdAt    DateTime    @default(now())
}

model Media {
    id        String   @id @default(cuid())
    name      String
    type      String
    size      Int
    url       String
    eventId   String?
    createdAt DateTime @default(now())
}

model PaymentChannel {
    id        String          @id @default(cuid())
    name      String
    type      PaymentCategory
    createdAt DateTime        @default(now())

    userChannels UserPaymentChannel[]
    orgChannels  OrgPaymentChannel[]
}

model UserPaymentChannel {
    id               String          @id @default(cuid())
    userId           String
    paymentChannelId String
    externalId       String
    type             PaymentCategory
    token            String
    design           String          @default("default")
    card_expired     DateTime?
    isActive         Boolean         @default(true)
    isPrimary        Boolean         @default(false)
    expiredAt        DateTime?
    createdAt        DateTime        @default(now())

    user           User           @relation(fields: [userId], references: [id])
    paymentChannel PaymentChannel @relation(fields: [paymentChannelId], references: [id])
    paymentHistories PaymentHistory[]
}

model OrgPaymentChannel {
    id               String   @id @default(cuid())
    organizationId   String
    paymentChannelId String
    createdAt        DateTime @default(now())

    organization   Organization   @relation(fields: [organizationId], references: [id])
    paymentChannel PaymentChannel @relation(fields: [paymentChannelId], references: [id])
    tickets        Ticket[]       @relation("TicketPaymentChannels")
}

model OrgLegalDocument {
    id           String   @id @default(cuid())
    orgId        String
    url          String
    type         String
    is_suspended Boolean  @default(false)
    uploadedAt   DateTime @default(now())

    organization Organization @relation(fields: [orgId], references: [id])
}

model EventInvoice {
    id        String   @id @default(cuid())
    ticketId  String
    eventId   String
    bookingId String
    createdAt DateTime @default(now())

    event   Event             @relation(fields: [eventId], references: [id])
    ticket  Ticket            @relation(fields: [ticketId], references: [id])
    booking CustomerBooking[]
}
